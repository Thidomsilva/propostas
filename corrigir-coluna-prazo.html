<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® CORRE√á√ÉO URGENTE - Adicionar Coluna Prazo</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            max-width: 1000px; 
            margin: 0 auto;
        }
        .btn { 
            background: #dc3545; 
            color: white; 
            padding: 15px 25px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover { 
            background: #c82333; 
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0;
            border: 1px solid #faeeba;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            margin: 10px 0;
        }
        .step {
            background: #e7f3ff;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            border-radius: 0 4px 4px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® PROBLEMA IDENTIFICADO: COLUNA PRAZO INEXISTENTE</h1>
        
        <div class="error">
            <strong>‚ùå ROOT CAUSE:</strong><br>
            A coluna "Prazo" n√£o existe fisicamente na planilha do Google Sheets!<br>
            Por isso os dados aparecem como "-" ou valores incorretos.
        </div>
        
        <div class="warning">
            <strong>‚ö†Ô∏è VERIFICA√á√ÉO NECESS√ÅRIA:</strong><br>
            Vamos testar se o backend consegue adicionar a coluna automaticamente ou se precisa ser feito manualmente.
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="verificarEstrutura()">üîç VERIFICAR ESTRUTURA DA PLANILHA</button>
            <button class="btn btn-success" onclick="adicionarColunaPrazo()">‚ûï ADICIONAR COLUNA PRAZO</button>
        </div>
        
        <div id="resultado"></div>
        
        <div class="step">
            <h3>üõ†Ô∏è SOLU√á√ÉO MANUAL (se o autom√°tico falhar):</h3>
            <ol>
                <li><strong>Abra o Google Sheets:</strong> <code>https://docs.google.com/spreadsheets/d/12TDtLrXg4NM6H4kc6_x8gjsQCdKl76fkuqFCRc4-QRo</code></li>
                <li><strong>V√° para a aba:</strong> "propostasacompanhamento"</li>
                <li><strong>Encontre a coluna F:</strong> Deve estar vazia ou ter outro nome</li>
                <li><strong>Na c√©lula F1, digite:</strong> <code>Prazo</code></li>
                <li><strong>Salve:</strong> Ctrl+S</li>
                <li><strong>Teste novamente:</strong> Volte ao painel e clique "Atualizar Lista"</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>üìã ESTRUTURA ESPERADA DA PLANILHA:</h3>
            <div class="code-block">
A1: Data<br>
B1: Cliente<br>
C1: Servi√ßo<br>
D1: Solicitante<br>
E1: Descri√ß√£o<br>
<strong>F1: Prazo ‚¨ÖÔ∏è ESTA COLUNA DEVE EXISTIR</strong><br>
G1: Status<br>
H1: Observa√ß√µes<br>
I1: Data Atualiza√ß√£o
            </div>
        </div>
        
        <div id="instrucoes-detalhadas" style="display: none;">
            <div class="success">
                <h3>‚úÖ PR√ìXIMOS PASSOS AP√ìS ADICIONAR A COLUNA:</h3>
                <ol>
                    <li>Verifique se a coluna "Prazo" aparece na posi√ß√£o F1</li>
                    <li>Teste criar uma nova solicita√ß√£o com prazo</li>
                    <li>Verifique se o prazo √© salvo corretamente</li>
                    <li>Confirme se aparece no painel de acompanhamento</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxx9o15oYbZmyk8jxhyWSCGvi6lLIDM6mpHJ2SJXbShEYTGeNInuei7Tys0IiLsICOu4Q/exec';
        
        function mostrarResultado(html) {
            document.getElementById('resultado').innerHTML = html;
        }
        
        function mostrarInstrucoes() {
            document.getElementById('instrucoes-detalhadas').style.display = 'block';
        }
        
        async function verificarEstrutura() {
            try {
                mostrarResultado('<div class="warning">üîÑ Verificando estrutura da planilha...</div>');
                
                const response = await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    const callbackName = 'corsCallback';
                    
                    window[callbackName] = function(data) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        resolve(data);
                    };
                    
                    script.src = `${API_URL}?action=listar&callback=${callbackName}`;
                    script.onerror = () => {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Erro na requisi√ß√£o'));
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            reject(new Error('Timeout'));
                        }
                    }, 10000);
                });
                
                console.log('üì¶ Resposta completa:', response);
                
                const dados = response.dados || response.data || [];
                
                if (dados.length > 0) {
                    const primeiroItem = dados[0];
                    const temPrazo = primeiroItem.hasOwnProperty('prazo');
                    const valorPrazo = primeiroItem.prazo;
                    
                    let html = `
                        <div class="success">
                            <h4>üìä ESTRUTURA VERIFICADA:</h4>
                            <strong>Total de registros:</strong> ${dados.length}<br>
                            <strong>Vers√£o do backend:</strong> ${response.versao}<br>
                            <strong>Campo 'prazo' existe:</strong> ${temPrazo ? '‚úÖ SIM' : '‚ùå N√ÉO'}<br>
                            <strong>Valor do primeiro prazo:</strong> "${valorPrazo}" (${typeof valorPrazo})<br>
                        </div>
                        
                        <div class="code-block">
                            <strong>Primeiro registro completo:</strong><br>
                            ${JSON.stringify(primeiroItem, null, 2)}
                        </div>
                    `;
                    
                    if (!temPrazo || valorPrazo === undefined || valorPrazo === null) {
                        html += `
                            <div class="error">
                                <strong>‚ùå CONFIRMADO: A coluna "Prazo" n√£o existe na planilha!</strong><br>
                                √â necess√°rio adicionar manualmente ou usar a fun√ß√£o autom√°tica.
                            </div>
                        `;
                        mostrarInstrucoes();
                    } else {
                        html += `
                            <div class="success">
                                <strong>‚úÖ A coluna "Prazo" existe!</strong><br>
                                O problema pode estar na renderiza√ß√£o do frontend.
                            </div>
                        `;
                    }
                    
                    mostrarResultado(html);
                } else {
                    mostrarResultado(`
                        <div class="warning">
                            ‚ö†Ô∏è Nenhum dado encontrado na planilha.<br>
                            Isso pode indicar que a planilha est√° vazia ou h√° problema de acesso.
                        </div>
                    `);
                }
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                mostrarResultado(`
                    <div class="error">
                        <strong>‚ùå Erro ao verificar estrutura:</strong><br>
                        ${error.message}
                    </div>
                `);
            }
        }
        
        async function adicionarColunaPrazo() {
            try {
                mostrarResultado('<div class="warning">üîÑ Tentando adicionar coluna "Prazo" automaticamente...</div>');
                
                // Fazer uma requisi√ß√£o especial para inicializar/verificar a planilha
                const response = await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    const callbackName = 'corsCallback' + Date.now();
                    
                    window[callbackName] = function(data) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        resolve(data);
                    };
                    
                    // Usar uma a√ß√£o que force a verifica√ß√£o da estrutura
                    script.src = `${API_URL}?action=listar&force_structure_check=true&callback=${callbackName}`;
                    script.onerror = () => {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Erro na requisi√ß√£o'));
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            reject(new Error('Timeout'));
                        }
                    }, 15000);
                });
                
                mostrarResultado(`
                    <div class="success">
                        <strong>‚úÖ Processo executado!</strong><br>
                        Vers√£o: ${response.versao}<br>
                        <br>
                        <strong>Agora fa√ßa o teste:</strong><br>
                        1. Volte ao painel principal<br>
                        2. Clique em "Atualizar Lista"<br>
                        3. Verifique se os prazos aparecem<br>
                        <br>
                        Se ainda n√£o funcionar, use a solu√ß√£o manual abaixo.
                    </div>
                `);
                
                mostrarInstrucoes();
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                mostrarResultado(`
                    <div class="error">
                        <strong>‚ùå Fun√ß√£o autom√°tica falhou:</strong><br>
                        ${error.message}<br>
                        <br>
                        <strong>Use a solu√ß√£o manual:</strong> Adicione a coluna "Prazo" manualmente na planilha.
                    </div>
                `);
                mostrarInstrucoes();
            }
        }
        
        // Auto-verificar ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(verificarEstrutura, 1000);
        });
    </script>
</body>
</html>
