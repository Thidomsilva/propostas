<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - AtualizaÃ§Ã£o de Status Otimizada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ğŸ§ª Teste Final - AtualizaÃ§Ã£o de Status Otimizada</h2>
                <p class="card-subtitle text-muted">Testando as correÃ§Ãµes implementadas no painel</p>
            </div>
            <div class="card-body">
                
                <div class="alert alert-info">
                    <h5>âœ… CorreÃ§Ãµes Implementadas:</h5>
                    <ul>
                        <li>Adicionado atributo <code>data-id</code> nas linhas da tabela</li>
                        <li>Criada funÃ§Ã£o <code>updateSingleRow()</code> para atualizaÃ§Ã£o otimizada</li>
                        <li>Melhorado logs e diagnostics na funÃ§Ã£o <code>updateStatus()</code></li>
                        <li>Fallback para re-renderizaÃ§Ã£o completa se atualizaÃ§Ã£o de linha falhar</li>
                    </ul>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="loadSolicitacoes()">
                            ğŸ”„ Carregar SolicitaÃ§Ãµes
                        </button>
                        <button class="btn btn-success" onclick="testeCompleto()">
                            ğŸš€ Teste Completo
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-warning" onclick="console.clear()">
                            ğŸ§¹ Limpar Console
                        </button>
                        <button class="btn btn-info" onclick="mostrarEstado()">
                            ğŸ“Š Mostrar Estado
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>Painel de Acompanhamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-primary" onclick="loadSolicitacoes()">
                                ğŸ”„ Atualizar Lista
                            </button>
                            <span id="loading-indicator" class="text-muted" style="display: none;">
                                Carregando...
                            </span>
                        </div>
                        
                        <div class="table-container">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Solicitante</th>
                                        <th>Cliente</th>
                                        <th>Projeto</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>AÃ§Ãµes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-solicitacoes">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            Clique em "Carregar SolicitaÃ§Ãµes" para iniciar
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="alert alert-secondary">
                        <h6>ğŸ” InstruÃ§Ãµes de Teste:</h6>
                        <ol>
                            <li>Clique em "Carregar SolicitaÃ§Ãµes" para buscar dados</li>
                            <li>Altere o status de uma solicitaÃ§Ã£o usando o dropdown</li>
                            <li>Observe se a atualizaÃ§Ã£o aparece imediatamente na tabela</li>
                            <li>Verifique o console do navegador para logs detalhados</li>
                            <li>Use "Teste Completo" para automatizar o processo</li>
                        </ol>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script src="js/api.js"></script>
    <script src="js/painel.js"></script>
    
    <script>
        // === FUNÃ‡Ã•ES DE TESTE ===
        async function testeCompleto() {
            console.log('ğŸš€ Iniciando teste completo...');
            
            try {
                // 1. Carregar dados
                console.log('ğŸ“‹ Passo 1: Carregando solicitaÃ§Ãµes...');
                await loadSolicitacoes();
                
                if (solicitacoes.length === 0) {
                    console.log('âš ï¸ Nenhuma solicitaÃ§Ã£o encontrada, criando dados de teste...');
                    solicitacoes = [
                        {
                            id: "TEST-1",
                            solicitante: "JoÃ£o Silva",
                            cliente: "Empresa A",
                            servico: "Projeto Web",
                            status: "Pendente",
                            data: "2024-01-15"
                        },
                        {
                            id: "TEST-2",
                            solicitante: "Maria Santos",
                            cliente: "Empresa B",
                            servico: "Consultoria",
                            status: "Em Andamento",
                            data: "2024-01-14"
                        }
                    ];
                    renderSolicitacoes();
                }
                
                // 2. Aguardar um pouco
                console.log('â³ Passo 2: Aguardando 2 segundos...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 3. Testar atualizaÃ§Ã£o
                console.log('ğŸ”„ Passo 3: Testando atualizaÃ§Ã£o de status...');
                const primeiroItem = solicitacoes[0];
                const statusOriginal = primeiroItem.status;
                const novoStatus = statusOriginal === 'Pendente' ? 'Em Andamento' : 'Pendente';
                
                console.log(`ğŸ¯ Alterando status do item ${primeiroItem.id}: ${statusOriginal} -> ${novoStatus}`);
                
                // Simular mudanÃ§a (sem chamar API real)
                await testarAtualizacaoLocal(primeiroItem.id, novoStatus);
                
                // 4. Verificar resultado
                console.log('âœ… Passo 4: Verificando resultado...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const itemAtualizado = solicitacoes.find(s => s.id === primeiroItem.id);
                if (itemAtualizado && itemAtualizado.status === novoStatus) {
                    console.log('âœ… TESTE APROVADO: Status atualizado corretamente na array');
                    
                    // Verificar na tabela HTML
                    const linha = document.querySelector(`tr[data-id="${primeiroItem.id}"]`);
                    if (linha) {
                        const statusBadge = linha.querySelector('.status-badge');
                        if (statusBadge && statusBadge.textContent.trim() === novoStatus) {
                            console.log('âœ… TESTE APROVADO: Status atualizado corretamente na tabela HTML');
                            showToast('ğŸ‰ Teste completo APROVADO!', 'success');
                        } else {
                            console.log('âŒ TESTE FALHADO: Status nÃ£o atualizado na tabela HTML');
                            showToast('âŒ Teste FALHADO - HTML nÃ£o atualizado', 'error');
                        }
                    } else {
                        console.log('âŒ TESTE FALHADO: Linha nÃ£o encontrada na tabela');
                        showToast('âŒ Teste FALHADO - Linha nÃ£o encontrada', 'error');
                    }
                } else {
                    console.log('âŒ TESTE FALHADO: Status nÃ£o atualizado na array');
                    showToast('âŒ Teste FALHADO - Array nÃ£o atualizada', 'error');
                }
                
            } catch (error) {
                console.error('âŒ Erro no teste completo:', error);
                showToast('âŒ Erro no teste completo', 'error');
            }
        }
        
        // FunÃ§Ã£o para testar atualizaÃ§Ã£o local sem API
        async function testarAtualizacaoLocal(id, novoStatus) {
            console.log(`ğŸ§ª Testando atualizaÃ§Ã£o local: ${id} -> ${novoStatus}`);
            
            // Simular resposta da API
            const response = { success: true, message: 'Status atualizado (simulado)' };
            
            // Executar a lÃ³gica de atualizaÃ§Ã£o local
            const item = solicitacoes.find(s => s.id == id);
            if (item) {
                console.log('âœ… Item encontrado:', item);
                const statusAnterior = item.status;
                item.status = novoStatus;
                console.log(`âœ… Status local atualizado de "${statusAnterior}" para "${item.status}"`);
                
                // Testar atualizaÃ§Ã£o de linha Ãºnica
                const linhaAtualizada = updateSingleRow(id, item);
                if (linhaAtualizada) {
                    console.log('âœ… Linha especÃ­fica atualizada com sucesso');
                } else {
                    console.log('âš ï¸ Linha especÃ­fica nÃ£o encontrada, re-renderizando tabela completa');
                    renderSolicitacoes();
                }
                
                showToast('Status atualizado localmente!', 'success');
            } else {
                console.error('âŒ Item nÃ£o encontrado na lista local');
                showToast('âŒ Item nÃ£o encontrado', 'error');
            }
        }
        
        function mostrarEstado() {
            console.log('ğŸ“Š Estado atual do sistema:');
            console.log('   - Total de solicitaÃ§Ãµes:', solicitacoes.length);
            console.log('   - SolicitaÃ§Ãµes:', solicitacoes);
            console.log('   - PÃ¡gina atual:', currentPage);
            
            const tbody = document.getElementById('tabela-solicitacoes');
            const linhas = tbody.querySelectorAll('tr[data-id]');
            console.log('   - Linhas na tabela:', linhas.length);
            
            linhas.forEach((linha, index) => {
                const id = linha.getAttribute('data-id');
                const statusBadge = linha.querySelector('.status-badge');
                const status = statusBadge ? statusBadge.textContent.trim() : 'N/A';
                console.log(`   - Linha ${index + 1}: ID=${id}, Status=${status}`);
            });
        }
        
        // === INICIALIZAÃ‡ÃƒO ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Teste final carregado');
            console.log('ğŸ’¡ Use "Teste Completo" para automatizar o teste');
            
            // Inicializar variÃ¡veis globais se necessÃ¡rio
            if (typeof solicitacoes === 'undefined') {
                window.solicitacoes = [];
            }
            if (typeof currentPage === 'undefined') {
                window.currentPage = 'painel';
            }
        });
    </script>
</body>
</html>
