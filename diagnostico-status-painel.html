<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Atualiza√ß√£o de Status no Painel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-pendente {
            background-color: #ffc107;
            color: #212529;
        }
        .status-em-andamento {
            background-color: #0d6efd;
            color: white;
        }
        .status-concluido {
            background-color: #198754;
            color: white;
        }
        .status-cancelado {
            background-color: #dc3545;
            color: white;
        }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üîç Diagn√≥stico - Atualiza√ß√£o de Status no Painel</h2>
                <p class="card-subtitle text-muted">Testando a atualiza√ß√£o local do status ap√≥s mudan√ßa</p>
            </div>
            <div class="card-body">
                
                <div class="alert alert-info">
                    <h5>üìù Objetivo do Teste:</h5>
                    <p>Verificar se o status √© atualizado localmente na tabela do painel ap√≥s a mudan√ßa, 
                    diagnosticando problemas de sincroniza√ß√£o local.</p>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="carregarDados()">
                            üîÑ Carregar Dados
                        </button>
                        <button class="btn btn-info" onclick="simularMudancaStatus()">
                            üß™ Simular Mudan√ßa
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-warning" onclick="limparLogs()">
                            üßπ Limpar Logs
                        </button>
                        <button class="btn btn-success" onclick="testarComparacao()">
                            üîç Testar Compara√ß√£o IDs
                        </button>
                    </div>
                </div>

                <div class="debug-info">
                    <h6>üìä Logs de Diagn√≥stico:</h6>
                    <div id="logs"></div>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Solicitante</th>
                                <th>Cliente</th>
                                <th>Projeto</th>
                                <th>Status (Badge)</th>
                                <th>Data</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-diagnostico">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    Clique em "Carregar Dados" para iniciar o diagn√≥stico
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4">
                    <h5>üîç Informa√ß√µes de Debug:</h5>
                    <div id="debug-info" class="debug-info">
                        <em>Dados de debug aparecer√£o aqui...</em>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // === CONFIGURA√á√ïES ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbwL7vGQbHyJ-lmDTcRHvuEQKZdGnZNvHZrVzBgPJo5JzqBrSgXmyBPWEbmjFJCIYRKZFQ/exec';
        
        // === DADOS SIMULADOS ===
        let solicitacoes = [];
        let logCount = 0;

        // === FUN√á√ïES DE LOG ===
        function adicionarLog(mensagem, tipo = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const cor = {
                'info': 'text-info',
                'success': 'text-success', 
                'warning': 'text-warning',
                'error': 'text-danger'
            }[tipo] || 'text-info';
            
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML += `<div class="${cor}">[${timestamp}] ${mensagem}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function limparLogs() {
            document.getElementById('logs').innerHTML = '';
            logCount = 0;
            adicionarLog('Logs limpos', 'info');
        }

        // === FUN√á√ïES UTILIT√ÅRIAS ===
        function getStatusClass(status) {
            const classes = {
                'Pendente': 'status-pendente',
                'Em Andamento': 'status-em-andamento',
                'Conclu√≠do': 'status-concluido',
                'Cancelado': 'status-cancelado'
            };
            return classes[status] || 'status-pendente';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                return '-';
            }
        }

        // === FUN√á√ÉO PRINCIPAL DE CARREGAMENTO ===
        async function carregarDados() {
            try {
                adicionarLog('üìã Iniciando carregamento de dados...', 'info');
                
                // Fazer chamada real para API
                const response = await fetch(API_URL + '?acao=listar');
                const data = await response.text();
                
                adicionarLog(`üì° Resposta recebida: ${data.substring(0, 100)}...`, 'info');
                
                // Tentar fazer parse do JSON
                let parsedData;
                try {
                    parsedData = JSON.parse(data);
                } catch (parseError) {
                    adicionarLog('‚ö†Ô∏è Erro de parse JSON, tentando extrair...', 'warning');
                    // Tentar extrair JSON v√°lido
                    const jsonMatch = data.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsedData = JSON.parse(jsonMatch[0]);
                        adicionarLog('‚úÖ JSON extra√≠do com sucesso', 'success');
                    } else {
                        throw new Error('N√£o foi poss√≠vel extrair JSON v√°lido');
                    }
                }
                
                adicionarLog(`üìä Dados parseados: ${JSON.stringify(parsedData, null, 2)}`, 'info');
                
                // Verificar estrutura da resposta
                const dados = parsedData?.data || parsedData?.dados || [];
                const isSuccess = parsedData?.success || parsedData?.sucesso || false;
                
                if (isSuccess && Array.isArray(dados)) {
                    solicitacoes = dados;
                    renderizarTabela();
                    adicionarLog(`‚úÖ ${solicitacoes.length} solicita√ß√µes carregadas`, 'success');
                    atualizarDebugInfo();
                } else {
                    throw new Error('Dados inv√°lidos recebidos');
                }
                
            } catch (error) {
                adicionarLog(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
                
                // Usar dados simulados para teste
                adicionarLog('üß™ Carregando dados simulados para teste...', 'warning');
                solicitacoes = [
                    {
                        id: "1",
                        solicitante: "Jo√£o Silva",
                        cliente: "Empresa A",
                        servico: "Projeto Web",
                        status: "Pendente",
                        data: "2024-01-15"
                    },
                    {
                        id: "2", 
                        solicitante: "Maria Santos",
                        cliente: "Empresa B",
                        servico: "Consultoria",
                        status: "Em Andamento",
                        data: "2024-01-14"
                    },
                    {
                        id: "3",
                        solicitante: "Pedro Costa",
                        cliente: "Empresa C", 
                        servico: "An√°lise",
                        status: "Conclu√≠do",
                        data: "2024-01-13"
                    }
                ];
                renderizarTabela();
                atualizarDebugInfo();
            }
        }

        // === FUN√á√ÉO DE RENDERIZA√á√ÉO ===
        function renderizarTabela() {
            const tbody = document.getElementById('tabela-diagnostico');
            if (!tbody) return;
            
            adicionarLog('üé® Renderizando tabela...', 'info');
            
            if (solicitacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            Nenhuma solicita√ß√£o encontrada
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = solicitacoes.map(item => `
                <tr data-id="${item.id}">
                    <td><span class="highlight">${item.id}</span> (${typeof item.id})</td>
                    <td>${item.solicitante || '-'}</td>
                    <td>${item.cliente || '-'}</td>
                    <td>${item.servico || '-'}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(item.status)}">
                            ${item.status || 'Pendente'}
                        </span>
                    </td>
                    <td>${formatDate(item.data) || '-'}</td>
                    <td>
                        <select class="form-control" onchange="atualizarStatus('${item.id}', this.value)">
                            <option value="Pendente" ${item.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="Em Andamento" ${item.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="Conclu√≠do" ${item.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                            <option value="Cancelado" ${item.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </td>
                </tr>
            `).join('');
            
            adicionarLog('‚úÖ Tabela renderizada com sucesso', 'success');
        }

        // === FUN√á√ÉO DE ATUALIZA√á√ÉO DE STATUS ===
        async function atualizarStatus(id, novoStatus) {
            try {
                adicionarLog(`üîÑ Atualizando status: ID=${id} (${typeof id}) -> ${novoStatus}`, 'info');
                
                // Buscar item ANTES da atualiza√ß√£o
                const itemAntes = solicitacoes.find(s => {
                    adicionarLog(`üîç Comparando: ${s.id} (${typeof s.id}) == ${id} (${typeof id})`, 'info');
                    return s.id == id;
                });
                
                if (itemAntes) {
                    adicionarLog(`‚úÖ Item encontrado ANTES: ${JSON.stringify(itemAntes)}`, 'success');
                } else {
                    adicionarLog(`‚ùå Item N√ÉO encontrado ANTES da atualiza√ß√£o`, 'error');
                    adicionarLog(`üìä IDs dispon√≠veis: ${solicitacoes.map(s => `${s.id} (${typeof s.id})`).join(', ')}`, 'info');
                }
                
                // Simular chamada para API (pode falhar, mas vamos testar a atualiza√ß√£o local)
                let apiSuccess = false;
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            acao: 'atualizar',
                            id: id,
                            status: novoStatus
                        })
                    });
                    
                    const data = await response.text();
                    const parsedData = JSON.parse(data);
                    apiSuccess = parsedData?.success || parsedData?.sucesso || false;
                    
                    if (apiSuccess) {
                        adicionarLog('‚úÖ Status atualizado no servidor', 'success');
                    } else {
                        adicionarLog('‚ö†Ô∏è API retornou erro, mas continuando teste local...', 'warning');
                    }
                } catch (apiError) {
                    adicionarLog(`‚ö†Ô∏è Erro na API: ${apiError.message}, continuando teste local...`, 'warning');
                }
                
                // TESTE DA ATUALIZA√á√ÉO LOCAL (independente do resultado da API)
                adicionarLog('üß™ Testando atualiza√ß√£o local...', 'info');
                
                const item = solicitacoes.find(s => {
                    const comparacao = s.id == id;
                    adicionarLog(`üîç Compara√ß√£o: ${s.id} == ${id} = ${comparacao}`, 'info');
                    return comparacao;
                });
                
                if (item) {
                    adicionarLog(`‚úÖ Item encontrado para atualiza√ß√£o: ${JSON.stringify(item)}`, 'success');
                    
                    const statusAnterior = item.status;
                    item.status = novoStatus;
                    
                    adicionarLog(`üîÑ Status alterado de "${statusAnterior}" para "${item.status}"`, 'info');
                    
                    // Re-renderizar tabela
                    renderizarTabela();
                    
                    // Verificar se a mudan√ßa foi aplicada
                    const itemVerificacao = solicitacoes.find(s => s.id == id);
                    if (itemVerificacao && itemVerificacao.status === novoStatus) {
                        adicionarLog('‚úÖ Atualiza√ß√£o local CONFIRMADA na array', 'success');
                        
                        // Verificar se apareceu na tabela
                        const linha = document.querySelector(`tr[data-id="${id}"]`);
                        if (linha) {
                            const statusBadge = linha.querySelector('.status-badge');
                            if (statusBadge && statusBadge.textContent.trim() === novoStatus) {
                                adicionarLog('‚úÖ Atualiza√ß√£o local CONFIRMADA na tabela HTML', 'success');
                            } else {
                                adicionarLog('‚ùå Atualiza√ß√£o local FALHOU na tabela HTML', 'error');
                            }
                        } else {
                            adicionarLog('‚ùå Linha n√£o encontrada na tabela HTML', 'error');
                        }
                    } else {
                        adicionarLog('‚ùå Atualiza√ß√£o local FALHOU na array', 'error');
                    }
                    
                    atualizarDebugInfo();
                } else {
                    adicionarLog('‚ùå Item n√£o encontrado na lista local', 'error');
                    adicionarLog(`üìä IDs dispon√≠veis: ${solicitacoes.map(s => `${s.id} (${typeof s.id})`).join(', ')}`, 'info');
                }
                
            } catch (error) {
                adicionarLog(`‚ùå Erro geral na atualiza√ß√£o: ${error.message}`, 'error');
            }
        }

        // === FUN√á√ÉO DE SIMULA√á√ÉO ===
        function simularMudancaStatus() {
            if (solicitacoes.length === 0) {
                adicionarLog('‚ö†Ô∏è Nenhuma solicita√ß√£o carregada. Carregue os dados primeiro.', 'warning');
                return;
            }
            
            const primeiroItem = solicitacoes[0];
            const novosStatus = ['Pendente', 'Em Andamento', 'Conclu√≠do', 'Cancelado'];
            const statusAtual = primeiroItem.status;
            const novoStatus = novosStatus.find(s => s !== statusAtual) || 'Em Andamento';
            
            adicionarLog(`üß™ Simulando mudan√ßa no item ID=${primeiroItem.id}: ${statusAtual} -> ${novoStatus}`, 'info');
            atualizarStatus(primeiroItem.id, novoStatus);
        }

        // === FUN√á√ÉO DE TESTE DE COMPARA√á√ÉO ===
        function testarComparacao() {
            if (solicitacoes.length === 0) {
                adicionarLog('‚ö†Ô∏è Nenhuma solicita√ß√£o carregada. Carregue os dados primeiro.', 'warning');
                return;
            }
            
            adicionarLog('üîç Testando compara√ß√µes de ID...', 'info');
            
            solicitacoes.forEach(item => {
                const id = item.id;
                const tipoId = typeof id;
                
                adicionarLog(`üìä Item ID: ${id} (${tipoId})`, 'info');
                
                // Testar diferentes tipos de compara√ß√£o
                const comparacoes = [
                    { teste: `${id} == "${id}"`, resultado: id == String(id) },
                    { teste: `${id} === "${id}"`, resultado: id === String(id) },
                    { teste: `${id} == ${Number(id)}`, resultado: id == Number(id) },
                    { teste: `${id} === ${Number(id)}`, resultado: id === Number(id) }
                ];
                
                comparacoes.forEach(comp => {
                    const cor = comp.resultado ? 'success' : 'warning';
                    adicionarLog(`   ${comp.teste} = ${comp.resultado}`, cor);
                });
            });
        }

        // === FUN√á√ÉO DE DEBUG INFO ===
        function atualizarDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = `
                <h6>üìä Estado Atual:</h6>
                <p><strong>Total de solicita√ß√µes:</strong> ${solicitacoes.length}</p>
                <p><strong>IDs e tipos:</strong></p>
                <ul>
                    ${solicitacoes.map(item => 
                        `<li>ID: ${item.id} (${typeof item.id}) - Status: ${item.status}</li>`
                    ).join('')}
                </ul>
                <p><strong>Logs gerados:</strong> ${logCount}</p>
            `;
        }

        // === INICIALIZA√á√ÉO ===
        document.addEventListener('DOMContentLoaded', function() {
            adicionarLog('üöÄ Diagn√≥stico carregado e pronto para uso', 'success');
            adicionarLog('üí° Clique em "Carregar Dados" para come√ßar', 'info');
        });
    </script>
</body>
</html>
